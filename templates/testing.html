{% extends "base.html" %}

{% block title %}Testing - ASR Testing Platform{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div></div>
                    <h4><i class="fas fa-microphone"></i> ASR Testing Session</h4>
                    <div>
                        <a href="{{ url_for('end_session', session_id=session_id) }}" 
                           class="btn btn-warning btn-sm" 
                           onclick="return confirm('Are you sure you want to end this session? You will be able to download reports.')">
                            <i class="fas fa-stop-circle"></i> End Session
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <strong>QA Name:</strong> {{ qa_name }}<br>
                        <strong>Language:</strong> {{ language.title() }}
                    </div>
                    <div class="col-md-6 text-end">
                        <strong>Progress:</strong> {{ crop_index + 1 }} / {{ total_crops }}<br>
                        <strong>Current Crop:</strong> {{ current_crop }}
                    </div>
                </div>
                
                <div class="progress mb-4">
                    <div class="progress-bar" role="progressbar" 
                         style="width: {{ ((crop_index + 1) / total_crops * 100) }}%">
                        {{ crop_index + 1 }}/{{ total_crops }}
                    </div>
                </div>
                
                <div class="alert alert-warning text-center">
                    <h5><i class="fas fa-seedling"></i> Crop Name: <strong>{{ current_crop }}</strong></h5>
                    <p class="mb-0">You need to record 5 audio samples using this crop name in sentences.</p>
                </div>
                
                <div id="recording-interface" class="text-center">
                    <div class="mb-4">
                        <h6>Recording Attempt: <span id="attempt-number">1</span> / 5</h6>
                    </div>
                    
                    <div class="mb-4">
                        <button id="start-recording" class="btn btn-success btn-lg me-2">
                            <i class="fas fa-microphone"></i> Start Recording
                        </button>
                        <button id="stop-recording" class="btn btn-danger btn-lg" disabled>
                            <i class="fas fa-stop"></i> Stop Recording
                        </button>
                    </div>
                    
                    <div class="recording-indicator">
                        <i class="fas fa-circle"></i> Recording...
                    </div>
                    
                    <div id="audio-playback" class="mt-3" style="display: none;">
                        <h6>Your Recording:</h6>
                        <audio id="audio-player" controls class="mb-3"></audio>
                        <br>
                        <button id="submit-recording" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Submit Recording
                        </button>
                        <button id="record-again" class="btn btn-secondary ms-2">
                            <i class="fas fa-redo"></i> Record Again
                        </button>
                    </div>
                </div>
                
                <div id="results-display" class="mt-4" style="display: none;">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-check-circle"></i> Recording Submitted!</h6>
                        <p><strong>Transcription:</strong> <span id="transcription-result"></span></p>
                        <p><strong>Keyword Detected:</strong> 
                            <span id="keyword-result" class="badge"></span>
                        </p>
                    </div>
                    <div class="text-center mt-3">
                        <a href="{{ url_for('end_session', session_id=session_id) }}" 
                           class="btn btn-warning" 
                           onclick="return confirm('Are you sure you want to end this session? You will be able to download reports.')">
                            <i class="fas fa-stop-circle"></i> End Session & Get Reports
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Instructions</h5>
            </div>
            <div class="card-body">
                <ol>
                    <li>Click "Start Recording" and speak a sentence that includes the crop name: <strong>{{ current_crop }}</strong></li>
                    <li>Click "Stop Recording" when you're done</li>
                    <li>Listen to your recording and click "Submit Recording" if satisfied</li>
                    <li>Repeat this process 5 times with different sentences</li>
                    <li>After 5 recordings, you'll move to the next crop name</li>
                </ol>
                <p class="text-muted">
                    <strong>Example sentences:</strong> "I planted {{ current_crop }} in my field", "The {{ current_crop }} crop is growing well", etc.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let mediaRecorder;
let audioChunks = [];
let currentAttempt = 1;
let sessionId = "{{ session_id }}";
let cropName = "{{ current_crop }}";
let cropIndex = {{ crop_index }};

const startBtn = document.getElementById('start-recording');
const stopBtn = document.getElementById('stop-recording');
const submitBtn = document.getElementById('submit-recording');
const recordAgainBtn = document.getElementById('record-again');
const recordingIndicator = document.querySelector('.recording-indicator');
const audioPlayback = document.getElementById('audio-playback');
const audioPlayer = document.getElementById('audio-player');
const resultsDisplay = document.getElementById('results-display');
const attemptNumber = document.getElementById('attempt-number');

startBtn.addEventListener('click', startRecording);
stopBtn.addEventListener('click', stopRecording);
submitBtn.addEventListener('click', submitRecording);
recordAgainBtn.addEventListener('click', recordAgain);

async function startRecording() {
    console.log('Start recording clicked');
    try {
        console.log('Requesting microphone access...');
        const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                sampleRate: 16000,
                channelCount: 1,
                echoCancellation: true,
                noiseSuppression: true
            }
        });
        console.log('Microphone access granted');
        
        // Try to use WAV format, fallback to webm
        let mimeType = 'audio/wav';
        if (!MediaRecorder.isTypeSupported('audio/wav')) {
            mimeType = 'audio/webm;codecs=opus';
        }
        
        mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
        audioChunks = [];
        
        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: mimeType });
            const audioUrl = URL.createObjectURL(audioBlob);
            audioPlayer.src = audioUrl;
            audioPlayback.style.display = 'block';
            
            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        recordingIndicator.style.display = 'block';
        
    } catch (error) {
        console.error('Microphone access error:', error);
        alert('Error accessing microphone: ' + error.message + '\n\nPlease make sure you have granted microphone permissions to this website.');
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
        recordingIndicator.style.display = 'none';
    }
}

function recordAgain() {
    audioPlayback.style.display = 'none';
    resultsDisplay.style.display = 'none';
    startBtn.disabled = false;
    stopBtn.disabled = true;
}

async function submitRecording() {
    if (audioChunks.length === 0) {
        alert('No recording to submit');
        return;
    }
    
    // Determine file extension based on mime type
    let mimeType = 'audio/wav';
    let fileExtension = 'wav';
    
    if (mediaRecorder && mediaRecorder.mimeType) {
        mimeType = mediaRecorder.mimeType;
        if (mimeType.includes('webm')) {
            fileExtension = 'webm';
        }
    }
    
    const audioBlob = new Blob(audioChunks, { type: mimeType });
    const formData = new FormData();
    formData.append('audio_file', audioBlob, `recording.${fileExtension}`);
    formData.append('session_id', sessionId);
    formData.append('crop_name', cropName);
    formData.append('attempt_number', currentAttempt);
    
    // DEBUG: Log what we're sending
    console.log(`DEBUG: Sending attempt ${currentAttempt} for crop ${cropName}`);
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    try {
        const response = await fetch('/submit_recording', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Display results
            document.getElementById('transcription-result').textContent = result.transcript;
            const keywordResult = document.getElementById('keyword-result');
            keywordResult.textContent = result.keyword_detected ? 'Yes' : 'No';
            keywordResult.className = result.keyword_detected ? 'badge bg-success' : 'badge bg-danger';
            
            resultsDisplay.style.display = 'block';
            
            // DEBUG: Log current attempt
            console.log(`Current attempt: ${currentAttempt}, Next attempt: ${currentAttempt + 1}`);
            
            // Move to next attempt or next crop
            currentAttempt++;
            if (currentAttempt <= 5) {
                attemptNumber.textContent = currentAttempt;
                console.log(`Continuing with attempt ${currentAttempt}/5`);
                // Increased time so users can note down results
                setTimeout(() => {
                    recordAgain();
                }, 8000); // Increased from 2 seconds to 8 seconds
            } else {
                console.log('All 5 attempts completed, moving to next crop');
                // All attempts done, move to next crop - give more time to review
                setTimeout(() => {
                    if (cropIndex + 1 < {{ total_crops }}) {
                        window.location.href = `/testing/{{ session_id }}/${cropIndex + 1}`;
                    } else {
                        window.location.href = `/results/{{ session_id }}`;
                    }
                }, 10000); // Increased from 3 seconds to 10 seconds
            }
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error submitting recording: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Recording';
    }
}
</script>
{% endblock %}
